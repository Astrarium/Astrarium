<c:DisposableUserControl x:Class="Astrarium.Plugins.Notes.Views.NotesControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:c="clr-namespace:Astrarium.Types.Controls;assembly=Astrarium.Types"
             xmlns:s="clr-namespace:Astrarium.Types.Themes;assembly=Astrarium.Types"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:t="clr-namespace:Astrarium.Types.Themes;assembly=Astrarium.Types"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <c:DisposableUserControl.Resources>

        <ResourceDictionary>

            <c:BindingProxy x:Key="DataContextProxy" Data="{Binding}" />

            <ContextMenu x:Key="RowMenu" DataContext="{Binding Source={StaticResource DataContextProxy}, Path=Data}">

                <MenuItem Header="View note" Command="{Binding ViewNoteCommand}" CommandParameter="{Binding SelectedNote}" />
                <Separator />
                <MenuItem Header="Set date and go to object" Command="{Binding SelectDateCommand}" CommandParameter="{Binding SelectedNote}" />
                <Separator />
                <MenuItem Header="Edit note" Command="{Binding EditNoteCommand}" CommandParameter="{Binding SelectedNote}" />
                <MenuItem Header="Delete note" Command="{Binding DeleteNoteCommand}" CommandParameter="{Binding SelectedNote}" />

            </ContextMenu>

            <Style x:Key="ImageButton" TargetType="{x:Type Button}" BasedOn="{StaticResource {x:Type ButtonBase}}">
                <Style.Setters>
                    <Setter Property="BorderBrush" Value="Transparent" />
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderThickness" Value="0" />
                    <Setter Property="Margin" Value="0" />
                    <Setter Property="Width" Value="18" />
                    <Setter Property="Height" Value="18" />
                    <Setter Property="HorizontalAlignment" Value="Right" />
                    <Setter Property="VerticalAlignment" Value="Center" />
                    <Setter Property="Cursor" Value="Hand" />
                </Style.Setters>
            </Style>

            <Grid x:Key="BtnDelete" x:Shared="False" >
                <Path HorizontalAlignment="Center" VerticalAlignment="Center" SnapsToDevicePixels="True" Width="12" Height="12" Stretch="Fill" Fill="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=Button}, Path=Foreground}" Data="F1 M 26.9166,22.1667L 37.9999,33.25L 49.0832,22.1668L 53.8332,26.9168L 42.7499,38L 53.8332,49.0834L 49.0833,53.8334L 37.9999,42.75L 26.9166,53.8334L 22.1666,49.0833L 33.25,38L 22.1667,26.9167L 26.9166,22.1667 Z "/>
            </Grid>

            <Grid x:Key="BtnEdit" x:Shared="False" >
                <Path HorizontalAlignment="Center" VerticalAlignment="Center" SnapsToDevicePixels="True" Width="12" Height="12" Stretch="Fill" Fill="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=Button}, Path=Foreground}" Data="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
            </Grid>

            <Style x:Key="DefaultRowStyle" TargetType="{x:Type DataGridRow}" BasedOn="{StaticResource {x:Type DataGridRow}}">
                <Setter Property="ContextMenu" Value="{StaticResource RowMenu}" />
            </Style>

        </ResourceDictionary>
    </c:DisposableUserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- View notes mode -->
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <Grid Margin="4 8" Visibility="{Binding IsEmpty, Converter={s:InverseBoolToVisibilityConverter}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <c:SearchTextBox Watermark="Type note fragment to filter" Text="{Binding FilterString, Mode=TwoWay, Delay=100, UpdateSourceTrigger=PropertyChanged}" Margin="0 0 8 0" />
                <Button Padding="8 0" Grid.Column="1" Content="+ New note" Command="{Binding AddNoteCommand}" />
            </Grid>

            <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center" Orientation="Vertical" Visibility="{Binding IsEmpty, Converter={t:BoolToVisibilityConverter}}">
                <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" IsEnabled="False" Text="There are no notes yet. Click Add to create first one." />
                <Button HorizontalAlignment="Center" Width="Auto" Content="Add" Margin="8" Padding="8 0" MinWidth="80" Command="{Binding AddNoteCommand}" />
            </StackPanel>

            <DataGrid 
                Grid.Row="1"
                ScrollViewer.VerticalScrollBarVisibility="Visible" 
                Style="{StaticResource {x:Type DataGrid}}"              
                VerticalScrollBarVisibility="Visible"
                HorizontalScrollBarVisibility="Hidden"
                EnableRowVirtualization="True"
                EnableColumnVirtualization="True"
                VirtualizingPanel.IsVirtualizingWhenGrouping="True"
                VirtualizingPanel.VirtualizationMode="Recycling"
                VirtualizingPanel.IsVirtualizing="True"
                AutoGenerateColumns="False"
                CanUserReorderColumns="False"
                CanUserSortColumns="True"
                CanUserResizeRows="False"
                IsReadOnly="True"
                GridLinesVisibility="None"
                BorderThickness="1"
                Margin="4"
                RowHeaderWidth="0"
                ColumnHeaderHeight="32"
                RowHeight="26"
                RowStyle="{StaticResource DefaultRowStyle}"
                SelectionMode="Single"
                SelectionUnit="FullRow"
                ItemsSource="{Binding Notes}"
                SelectedItem="{Binding SelectedNote}" 
                Visibility="{Binding IsEmpty, Converter={s:InverseBoolToVisibilityConverter}}">
                <DataGrid.InputBindings>
                    <MouseBinding Gesture="LeftDoubleClick" Command="{Binding Source={StaticResource DataContextProxy}, Path=Data.ViewNoteCommand}" CommandParameter="{Binding SelectedNote}" />
                </DataGrid.InputBindings>

                <DataGrid.Columns>

                    <DataGridTemplateColumn Header="Body" CanUserSort="True" SortMemberPath="." MinWidth="40" Visibility="{Binding Source={StaticResource DataContextProxy}, Path=Data.AllNotes, Converter={s:BoolToVisibilityConverter}}">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Background="Transparent" ToolTip="{Binding Body, Converter={s:CelestialObjectFullNameConverter}}">
                                    <Rectangle Margin="2" Width="16" Height="16" ToolTip="{Binding Body, Converter={s:CelestialObjectTypeDescriptionConverter}}">
                                        <Rectangle.Fill>
                                            <SolidColorBrush Color="{DynamicResource ColorControlLightBackground}" />
                                        </Rectangle.Fill>
                                        <Rectangle.OpacityMask>
                                            <ImageBrush ImageSource="{Binding Body, Converter={s:CelestialObjectToIconConverter}}" Stretch="Uniform" />
                                        </Rectangle.OpacityMask>
                                    </Rectangle>
                                    <TextBlock Padding="4 0 0 0" Text="{Binding Body, Converter={s:CelestialObjectNameConverter}}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" />
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTemplateColumn Header="Date" SortDirection="Descending" CanUserResize="False" Width="125" SortMemberPath="Date">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock>
                                     <TextBlock VerticalAlignment="Center" ToolTip="Click to set the date">
                                         <Hyperlink Command="{Binding Data.SelectDateCommand, Source={StaticResource DataContextProxy}}" CommandParameter="{Binding}">                                                 
                                             <Run>
                                                 <Run.Text>
                                                     <MultiBinding Converter="{s:JulianDayToStringConverter}">
                                                         <Binding Path="Date" />
                                                         <Binding Path="Data.UtcOffset" Source="{StaticResource DataContextProxy}" Mode="OneWay" />
                                                     </MultiBinding>
                                                 </Run.Text>
                                             </Run>
                                         </Hyperlink>
                                     </TextBlock>
                                </TextBlock>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTemplateColumn Header="Title" CanUserSort="False" MinWidth="40">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Title}" TextTrimming="CharacterEllipsis" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTemplateColumn Width="*" Header="Description" MinWidth="40" CanUserSort="False" >
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Grid HorizontalAlignment="Stretch">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Visibility="{Binding Markdown, Converter={s:InverseBoolToVisibilityConverter}}" Text="{Binding Description, Converter={t:SingleLineTextConverter}}" TextTrimming="CharacterEllipsis" />
                                    <TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Visibility="{Binding Markdown, Converter={s:BoolToVisibilityConverter}}" Text="{Binding Description, Converter={t:MarkdownToPlainTextConverter}}" TextTrimming="CharacterEllipsis" />

                                    <Button Grid.Column="1" Content="{StaticResource BtnEdit}" Style="{StaticResource ImageButton}" 
                                            Visibility="{Binding IsSelected, Converter={t:BoolToVisibilityConverter},
                                            RelativeSource={RelativeSource FindAncestor, AncestorType=DataGridRow}}"
                                            Command="{Binding Source={StaticResource DataContextProxy}, Path=Data.EditNoteCommand}"
                                            ToolTip="Edit" />

                                    <Button Grid.Column="2" Content="{StaticResource BtnDelete}" Style="{StaticResource ImageButton}" Margin="8 0 0 0"
                                            Visibility="{Binding IsSelected, Converter={t:BoolToVisibilityConverter},
                                            RelativeSource={RelativeSource FindAncestor, AncestorType=DataGridRow}}"
                                            Command="{Binding Source={StaticResource DataContextProxy}, Path=Data.DeleteNoteCommand}"
                                            ToolTip="Delete" />
                                </Grid>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                </DataGrid.Columns>

            </DataGrid>
        </Grid>
    </Grid>

</c:DisposableUserControl>
